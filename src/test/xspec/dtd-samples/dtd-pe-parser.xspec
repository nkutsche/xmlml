<?xml version="1.0" encoding="UTF-8"?>
<x:description xmlns:x="http://www.jenitennison.com/xslt/xspec" xmlns:dtdpe="http://www.nkutsche.com/dtd-pe-parser" xmlns:mlml="http://www.nkutsche.com/xmlml"
    xmlns:mlmlt="http://www.nkutsche.com/xmlml/test-helper"
    xmlns:dml="http://www.nkutsche.com/dtdml"
    xmlns:map="http://www.w3.org/2005/xpath-functions/map" xmlns:xs="http://www.w3.org/2001/XMLSchema" stylesheet="../../../main/resources/xsl/xmlml-main.xsl">
    
    <x:helper stylesheet="../../resources/xsl/helper.xsl"/>
    
    <x:variable name="si" select="map{'base-uri' : 'http://www.nkutsche.com/xmlml/xspec-test.xml'}"/>
    
    <x:variable name="resources" select="res">
        <res id="foo.ent">
            <![CDATA[<!ELEMENT foo EMPTY>]]>
        </res>
        <res id="foo%20;bar.ent">
            <![CDATA[
                <!ELEMENT foo EMPTY>
                <!ELEMENT bar EMPTY>
            ]]>
        </res>
    </x:variable>
    
    <x:variable name="config" select="map:put(
        $default-config, $mlml:URI_RESOLVER, function($href, $baseuri){
            if($resources[resolve-uri(@id, $si?base-uri) = $href])
            then 
                (map{'content' : string($resources[resolve-uri(@id, $si?base-uri) = $href]), 'base-uri' : resolve-uri($href, $baseuri)},
                mlmlt:message('systemId: ' || $href), 
                mlmlt:message('content: ' || string($resources[resolve-uri(@id, $si?base-uri) = $href]))
                )
            else 
                error(xs:QName('mlml:missing-resource'), 'Coult not find resource with base-uri ' || $href )
        }
        )"/>
    <x:scenario label="generic-dtd-test" shared="true">
        <x:scenario label="resolve parameter entities by preparse">
            <x:call function="mlml:dtd-pre-parse">
                <x:param select="$src-dtd ! map:put($si, 'content', string(.))"/>
                <x:param select="$config"/>
            </x:call>
            <x:expect label="Effective DTD as plain text" test="
                if($x:result instance of map(*)) 
                then $x:result 
                else normalize-space($x:result => string-join())
                " select="normalize-space($resolved-dtd)"/>
        </x:scenario>

        <x:scenario label="validate DTD">
            <x:call function="mlml:validate-dtd">
                <x:param select="
                    mlmlt:try-catch(
                        function(){
                            mlml:parse-dtds-from-string(string($src-dtd), $si?base-uri, $config)
                        }
                    )
                    "/>
            </x:call>
            <x:expect label="expected valid dtd">
                <dtd xmlns="http://www.nkutsche.com/dtdml">...</dtd>
            </x:expect>
        </x:scenario>
        
    </x:scenario>
    
    <x:scenario label="Testing function mlml:dtd-pre-parse" catch="true">
        <x:scenario label="No Parameter Entity">
            <x:variable name="src-dtd">
                <![CDATA[<!ELEMENT foo EMPTY>]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[<!ELEMENT foo EMPTY>]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>
        
        <x:scenario label="No Parameter Entity - percent in System path">
            <x:variable name="src-dtd">
                <![CDATA[
                    <!ENTITY % param SYSTEM "path%20.ent">
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                    <!ENTITY % param SYSTEM "http://www.nkutsche.com/xmlml/path%20.ent">
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>

        <x:scenario label="Trivial Parameter Entity">
            <x:variable name="src-dtd">
                <![CDATA[
                    <!ENTITY % foo "bar">
                    <!ELEMENT %foo; EMPTY>
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                    <!ENTITY % foo "bar">
                    <!ELEMENT bar EMPTY>
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>
        <x:scenario label="Parameter Entity as value">
            <x:variable name="src-dtd">
                <![CDATA[
                    <!ENTITY % value "'efvalue'">
                    <!ENTITY % param %value;>
                    <!ELEMENT %param; EMPTY>
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                    <!ENTITY % value "'efvalue'">
                    <!ENTITY % param 'efvalue' >
                    <!ELEMENT efvalue EMPTY>
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>

        <x:scenario label="Parameter Entity - percent as PEref">
            <x:variable name="src-dtd">
                <![CDATA[
                    <!ENTITY % perc "&#x25;">
                    <!ENTITY%perc;param "value">
                    <!ELEMENT %param; EMPTY>
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                    <!ENTITY % perc "%">
                    <!ENTITY % param "value">
                    <!ELEMENT value EMPTY>
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>

        <x:scenario label="Parameter Entity - name as PEref">
            <x:variable name="src-dtd">
                <![CDATA[
                    <!ENTITY % param "param-name">
                    <!ENTITY %%param; "value">
                    <!ELEMENT %param-name; EMPTY>
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                    <!ENTITY % param "param-name">
                    <!ENTITY % param-name "value">
                    <!ELEMENT value EMPTY>
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>
        
        <x:scenario label="Parameter Entity - System keyword as PEref">
            <x:variable name="src-dtd">
                <![CDATA[
                    <!ENTITY % system "SYSTEM">
                    <!ENTITY % param %system; "path%20.ent">
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                    <!ENTITY % system "SYSTEM">
                    <!ENTITY % param SYSTEM "http://www.nkutsche.com/xmlml/path%20.ent">
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>

        <x:scenario label="Recursive Parameter Entity">
            <x:variable name="src-dtd">
                <![CDATA[
                <!ENTITY % foo "bar">
                <!ENTITY % bar "%foo; EMPTY">
                <!ELEMENT %bar;>
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                    <!ENTITY % foo "bar">
                    <!ENTITY % bar "bar EMPTY">
                    <!ELEMENT bar EMPTY >
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>

        <x:scenario label="External Parameter Entity">
            <x:variable name="src-dtd">
                <![CDATA[
                <!ENTITY % foo SYSTEM "foo.ent">
                %foo;
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                    <!ENTITY % foo SYSTEM "http://www.nkutsche.com/xmlml/foo.ent">
                    <!ELEMENT foo EMPTY>
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>

        <x:scenario label="Parameter Entity entity declaration">
            <x:variable name="src-dtd">
                <![CDATA[
                    <!ENTITY % root_prefix "ns:" >
                    <!ENTITY % root_name "%root_prefix;root" >
                    <!ELEMENT %root_name; (foo?, (bar | baz)+) >
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                    <!ENTITY % root_prefix "ns:" >
                    <!ENTITY % root_name "ns:root" >
                    <!ELEMENT ns:root (foo?, (bar | baz)+) >
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>

        <x:scenario label="Parameter Entity Kung-Fu">
            <x:variable name="src-dtd">
                <![CDATA[
                    <!ENTITY % percd "&#37;" >
                    <!ENTITY % perc "&#x25;" >
                    <!ENTITY % baz "baz" >
                    <!ENTITY %percd; foo "bar '%baz;'" >
                    
                    <!ENTITY%perc;%foo;>
                    
                    <!ELEMENT %bar; EMPTY>
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                        <!ENTITY % percd "%" >
                        <!ENTITY % perc "%" >
                        <!ENTITY % baz "baz" >
                        <!ENTITY % foo "bar 'baz'" >
                        
                        <!ENTITY % bar 'baz' >
                        
                        <!ELEMENT baz EMPTY>
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>

        <x:scenario label="No Parameter Entity in System path">
            <x:variable name="src-dtd">
                <![CDATA[
                    <!ENTITY % ext SYSTEM "foo%20;bar.ent" >
                    %ext;
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                        <!ENTITY % ext SYSTEM "http://www.nkutsche.com/xmlml/foo%20;bar.ent" >
                        <!ELEMENT foo EMPTY>
                        <!ELEMENT bar EMPTY>
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>

        <x:scenario label="Invalide percent in quoted value is ignored">
            <x:variable name="src-dtd">
                <![CDATA[
                    <!ENTITY % perc "%" >
                    <!ENTITY %perc; param "value" >
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                        <!ENTITY % perc "%" >
                        <!ENTITY % param "value" >
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>

        <x:scenario label="Insert space before and after PE reference">
            <x:variable name="src-dtd">
                <![CDATA[
                    <!ELEMENT doc (#PCDATA)>
                    <!ENTITY % e "'v1'">
                    <!ATTLIST doc a1 CDATA%e;>
                ]]>
            </x:variable>
            <x:variable name="resolved-dtd">
                <![CDATA[
                    <!ELEMENT doc (#PCDATA)>
                    <!ENTITY % e "'v1'">
                    <!ATTLIST doc a1 CDATA 'v1' >
                ]]>
            </x:variable>
            <x:like label="generic-dtd-test"/>
        </x:scenario>

        <x:scenario label="Quotes may need to be escaped, if they are inserted by">
            
            <x:scenario label="a character entity (double quote)">
                <x:variable name="src-dtd">
                    <![CDATA[
                        <!ENTITY q "&#34;">
                        <!ENTITY qx "&#x22;">
                        <!ENTITY sq '&#34;'>
                    ]]>
                </x:variable>
                <x:variable name="resolved-dtd">
                    <![CDATA[
                        <!ENTITY q "&#34;">
                        <!ENTITY qx "&#34;">
                        <!ENTITY sq '"'>
                    ]]>
                </x:variable>
                <x:like label="generic-dtd-test"/>
            </x:scenario>

            <x:scenario label="a character entity (single quote)">
                <x:variable name="src-dtd">
                    <![CDATA[
                        <!ENTITY q '&#39;'>
                        <!ENTITY qx '&#x27;'>
                        <!ENTITY dq "&#39;">
                    ]]>
                </x:variable>
                <x:variable name="resolved-dtd">
                    <![CDATA[
                        <!ENTITY q '&#39;'>
                        <!ENTITY qx '&#39;'>
                        <!ENTITY dq "'">
                    ]]>
                </x:variable>
                <x:like label="generic-dtd-test"/>
            </x:scenario>
    
    
            <x:scenario label="a parameter entity reference (double quote)">
                <x:variable name="src-dtd">
                    <![CDATA[
                        <!ENTITY % q '"'>
                        <!ENTITY e "%q;">
                        <!ENTITY e2 '%q;'>
                    ]]>
                </x:variable>
                <x:variable name="resolved-dtd">
                    <![CDATA[
                        <!ENTITY % q '"'>
                        <!ENTITY e "&#34;">
                        <!ENTITY e2 '"'>
                    ]]>
                </x:variable>
                <x:like label="generic-dtd-test"/>
            </x:scenario>
            
            <x:scenario label="a parameter entity reference (single quote)">
                <x:variable name="src-dtd">
                    <![CDATA[
                        <!ENTITY % q "'">
                        <!ENTITY e '%q;'>
                        <!ENTITY e2 "%q;">
                    ]]>
                </x:variable>
                <x:variable name="resolved-dtd">
                    <![CDATA[
                        <!ENTITY % q "'">
                        <!ENTITY e '&#39;'>
                        <!ENTITY e2 "'">
                    ]]>
                </x:variable>
                <x:like label="generic-dtd-test"/>
            </x:scenario>
            
        </x:scenario>
        
    </x:scenario>
    
</x:description>
